ticket_meta:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"
  ticket:
    id: "TCK-00071"
    title: "Improve Temp File Lifecycle Management"
  binds:
    prd_id: "NONE"
    rfc_id: "RFC-0006"
    requirements:
      - requirement_id: "MAINT-018"
        requirement_ref: "documents/rfcs/RFC-0006/01_problem_and_imports.yaml#rfc_local_requirements.requirements[12]"
    evidence_artifacts: []
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_BUILD_RELEASE"
      - "DOMAIN_SECURITY"
  dependencies:
    tickets:
      - "TCK-00067"
      - "TCK-00069"
  scope:
    in_scope:
      - "Create ManagedTempFile wrapper struct that tracks files in state"
      - "Register temp files in reviewer_state.json for cleanup on remediation"
      - "Add cleanup sweep on cargo xtask check for orphaned temp files older than 1 hour"
      - "Remove rm -f from shell command strings throughout codebase"
      - "Implement temp file tracking in ReviewerEntry struct"
      - "Add orphan detection and cleanup logic"
      - "Update push.rs and review.rs to use ManagedTempFile"
    out_of_scope:
      - "Changes to tempfile crate usage (still use tempfile for creation)"
      - "Persistent log storage"
      - "Changes to reviewer health monitoring logic"
      - "Changes to AI reviewer prompt content"
  plan:
    steps:
      - "Audit codebase for rm -f in shell command strings"
      - "Design ManagedTempFile struct with fields: path, created_at, review_type"
      - "Add temp_files: Vec<PathBuf> field to ReviewerEntry in reviewer_state.rs"
      - "Implement ManagedTempFile::new() that creates temp file and registers in state"
      - "Implement ManagedTempFile::cleanup() that removes file and updates state"
      - "Add cleanup_orphaned_temp_files() function to reviewer_state.rs"
      - "Orphan detection: temp files in state but no associated running reviewer"
      - "Age threshold: clean up temp files older than 1 hour"
      - "Update push.rs to register temp files (prompt, log) in ReviewerEntry"
      - "Update review.rs to register temp files in ReviewerEntry"
      - "Update check.rs remediate_reviewer() to clean up old temp files before restart"
      - "Add orphan cleanup call to check.rs run_check() function"
      - "Remove all rm -f from shell command construction in codebase"
      - "Add unit tests for temp file registration and cleanup"
      - "Add integration test for orphan cleanup"
      - "Verify cargo build succeeds"
      - "Verify cargo test passes"
      - "Verify cargo clippy passes with no warnings"
  definition_of_done:
    evidence_ids: []
    criteria:
      - "ManagedTempFile struct exists for tracking temp files in state"
      - "ReviewerEntry includes temp_files field tracking associated files"
      - "No rm -f in shell command construction anywhere in xtask codebase"
      - "Temp files registered in reviewer_state.json on creation"
      - "Temp files cleaned up on successful review completion"
      - "Temp files cleaned up on remediation (before restart)"
      - "Orphaned temp files (>1 hour old, no running reviewer) cleaned up by cargo xtask check"
      - "push.rs registers prompt and log temp files in state"
      - "review.rs registers prompt and log temp files in state"
      - "cleanup_orphaned_temp_files() called during check command execution"
      - "Unit tests verify temp file registration works"
      - "Unit tests verify cleanup removes files and updates state"
      - "cargo build succeeds"
      - "cargo test passes"
      - "cargo clippy passes with no warnings"
  notes:
    security: |
      Proper temp file lifecycle management prevents:
      - Disk space leaks from orphaned temp files
      - Potential information disclosure from lingering temp files
      - Race conditions from manual rm -f in shell commands

      State-tracked cleanup is more reliable than shell-based cleanup because:
      - Works even if process is killed (SIGKILL)
      - Handles partial failures gracefully
      - Provides audit trail of temp file usage
    implementation_details: |
      ManagedTempFile structure:
      ```rust
      pub struct ManagedTempFile {
          path: PathBuf,
          created_at: DateTime<Utc>,
          review_type: String,
      }
      ```

      ReviewerEntry with temp files:
      ```rust
      #[derive(Debug, Clone, Serialize, Deserialize)]
      pub struct ReviewerEntry {
          pub pid: u32,
          pub started_at: DateTime<Utc>,
          pub log_file: PathBuf,
          pub prompt_file: PathBuf,  // Added
          pub pr_url: String,
          pub head_sha: String,
          pub temp_files: Vec<PathBuf>,  // Added
      }
      ```

      Orphan cleanup logic:
      ```rust
      pub fn cleanup_orphaned_temp_files(state: &mut ReviewerStateFile) -> Result<Vec<PathBuf>> {
          let mut cleaned = Vec::new();
          let one_hour_ago = Utc::now() - chrono::Duration::hours(1);

          for (name, entry) in &state.reviewers {
              // Skip if reviewer is still alive
              if entry.check_health() != HealthStatus::Dead {
                  continue;
              }

              // Clean up temp files for dead reviewers older than 1 hour
              if entry.started_at < one_hour_ago {
                  for path in &entry.temp_files {
                      if path.exists() {
                          let _ = std::fs::remove_file(path);
                          cleaned.push(path.clone());
                      }
                  }
              }
          }

          // Remove dead entries older than 1 hour
          state.reviewers.retain(|_, e| {
              e.check_health() != HealthStatus::Dead || e.started_at >= one_hour_ago
          });

          state.save()?;
          Ok(cleaned)
      }
      ```
    api_versioning: |
      This ticket builds on structures from TCK-00067 (ReviewerEntry) and
      TCK-00069 (ReviewerSpawner). Ensure compatibility with those implementations.
    affected_files: |
      Modified: xtask/src/reviewer_state.rs (ManagedTempFile, temp_files field, cleanup logic)
      Modified: xtask/src/tasks/push.rs (register temp files, remove rm -f)
      Modified: xtask/src/tasks/review.rs (register temp files, remove rm -f)
      Modified: xtask/src/tasks/check.rs (call orphan cleanup, remove rm -f in restart_review())
