rfc_contracts_and_versioning:
  schema_version: "2026-01-24"
  template_version: "2026-01-24"
  contracts:
  - id: CTR-3001
    name: "Holon Trait Contract"
    type: API
    versioning:
      scheme: SEMVER
      current_version: "0.1.0"
      compatibility_rules:
      - "Associated types may be extended with new variants in minor versions"
      - "New trait methods require default implementations for minor versions"
      - "Breaking changes to existing methods require major version bump"
    schemas:
    - id: SCH-3001
      path: "crates/apm2-holon/src/holon/traits.rs"
      format: RUST_TRAIT
      description: "Core Holon trait defining the contract surface"
      inline_schema: |
        /// A holon is a bounded agent with a typed contract surface.
        /// Implements Axiom I (Markov Blanket) from Principia Holonica.
        pub trait Holon: Send + Sync {
            /// Input type for work requests
            type Input: Send + Sync;
            /// Output type for completed work
            type Output: Send + Sync;
            /// Internal state type (ephemeral, not persisted)
            type State: Default + Send + Sync;

            /// Intake a work request with lease authority.
            /// Returns WorkId for tracking.
            fn intake(&mut self, input: Self::Input, lease: Lease) -> Result<WorkId, HolonError>;

            /// Execute a bounded episode within the current context.
            /// Returns episode result for stop condition evaluation.
            fn execute_episode(
                &mut self,
                work_id: WorkId,
                context: EpisodeContext,
            ) -> Result<EpisodeResult, HolonError>;

            /// Emit an artifact to the ledger.
            /// Returns ArtifactId for reference.
            fn emit_artifact(
                &mut self,
                work_id: WorkId,
                artifact: Artifact,
            ) -> Result<ArtifactId, HolonError>;

            /// Escalate work to supervisor.
            /// Used when holon cannot proceed autonomously.
            fn escalate(
                &mut self,
                work_id: WorkId,
                reason: EscalationReason,
            ) -> Result<(), HolonError>;

            /// Evaluate stop conditions for current work.
            fn should_stop(&self, work_id: WorkId) -> StopCondition;
        }

    - id: SCH-3002
      path: "crates/apm2-holon/src/holon/types.rs"
      format: RUST_TYPE
      description: "Supporting types for Holon trait"
      inline_schema: |
        /// Episode execution context (bounded context window).
        /// Implements curated context provisioning per Axiom V.
        #[derive(Debug, Clone)]
        pub struct EpisodeContext {
            /// Goal specification for this episode
            pub goal: GoalSpec,
            /// Snapshot of current state
            pub state_snapshot: StateSnapshot,
            /// Constraints on execution
            pub constraints: Constraints,
            /// Resource budget for this episode
            pub budget: Budget,
            /// References to relevant artifacts
            pub artifacts: Vec<ArtifactRef>,
        }

        /// Stop condition predicates evaluated after each episode.
        #[derive(Debug, Clone, PartialEq)]
        pub enum StopCondition {
            /// Continue to next episode
            Continue,
            /// Goal satisfied with evidence
            GoalSatisfied { evidence: Vec<EvidenceId> },
            /// Resource budget exhausted
            BudgetExhausted { resource: ResourceType },
            /// Blocked on external dependency
            Blocked { reason: BlockedReason },
            /// Escalate to supervisor
            Escalate { reason: EscalationReason },
        }

        /// Result of a single episode execution.
        #[derive(Debug, Clone)]
        pub struct EpisodeResult {
            /// Episode identifier
            pub episode_id: EpisodeId,
            /// Proposals generated during episode
            pub proposals: Vec<Proposal>,
            /// Artifacts produced during episode
            pub artifacts: Vec<ArtifactRef>,
            /// Tool calls made during episode
            pub tool_calls: Vec<ToolCallRecord>,
            /// Updated progress state
            pub progress: ProgressState,
        }

    evidence_ids:
    - EVID-3001

  - id: CTR-3002
    name: "Work Object Schema"
    type: DATA_SCHEMA
    versioning:
      scheme: SEMVER
      current_version: "0.1.0"
      compatibility_rules:
      - "New optional fields may be added in minor versions"
      - "Lifecycle states may be extended with new variants in minor versions"
      - "Existing state transitions must be preserved"
    schemas:
    - id: SCH-3001
      path: "crates/apm2-holon/src/work/mod.rs"
      format: RUST_TYPE
      description: "Work object and lifecycle types"
      inline_schema: |
        /// First-class work object with stable identity.
        /// Implements structured work tracking per Axiom II.
        #[derive(Debug, Clone)]
        pub struct WorkObject {
            /// Stable work identifier
            pub id: WorkId,
            /// Current lifecycle state
            pub lifecycle: WorkLifecycle,
            /// Bound requirement identifiers
            pub requirements: Vec<RequirementId>,
            /// Execution constraints
            pub constraints: Constraints,
            /// Produced artifact identifiers
            pub artifacts: Vec<ArtifactId>,
            /// Execution attempt history
            pub attempts: Vec<AttemptRecord>,
        }

        /// Work lifecycle state machine.
        #[derive(Debug, Clone, PartialEq)]
        pub enum WorkLifecycle {
            /// Work created but not yet claimed
            Pending,
            /// Work claimed with active lease
            InProgress {
                started_at: DateTime<Utc>,
                lease: LeaseId,
            },
            /// Work blocked on external dependency
            Blocked {
                reason: BlockedReason,
                since: DateTime<Utc>,
            },
            /// Work completed with evidence
            Completed {
                evidence: Vec<EvidenceId>,
                completed_at: DateTime<Utc>,
            },
            /// Work failed with error record
            Failed {
                error: ErrorRecord,
            },
            /// Work escalated to supervisor
            Escalated {
                to: HolonId,
                reason: EscalationReason,
            },
        }

        /// Record of a work execution attempt.
        #[derive(Debug, Clone)]
        pub struct AttemptRecord {
            pub attempt_id: AttemptId,
            pub episode_ids: Vec<EpisodeId>,
            pub started_at: DateTime<Utc>,
            pub ended_at: Option<DateTime<Utc>>,
            pub outcome: AttemptOutcome,
        }

    evidence_ids:
    - EVID-3003

  - id: CTR-3003
    name: "Lease and Budget Schema"
    type: DATA_SCHEMA
    versioning:
      scheme: SEMVER
      current_version: "0.1.0"
      compatibility_rules:
      - "New resource types may be added to Budget in minor versions"
      - "Lease scope may be extended with new scope types"
      - "Expiration semantics must be preserved"
    schemas:
    - id: SCH-3001
      path: "crates/apm2-holon/src/resource/lease.rs"
      format: RUST_TYPE
      description: "Lease and budget resource types"
      inline_schema: |
        /// Time-bounded authority token granting resource access.
        /// Implements Axiom IV (Resource Boundedness).
        #[derive(Debug, Clone)]
        pub struct Lease {
            /// Unique lease identifier
            pub id: LeaseId,
            /// Holon that issued this lease
            pub granted_by: HolonId,
            /// Holon that holds this lease
            pub granted_to: HolonId,
            /// Scope of permitted actions
            pub scope: LeaseScope,
            /// Expiration timestamp
            pub expires_at: DateTime<Utc>,
            /// Resource budget for this lease
            pub budget: Budget,
            /// Registrar signature
            pub signature: Signature,
        }

        /// Resource budget with multiple dimensions.
        #[derive(Debug, Clone, Default)]
        pub struct Budget {
            /// Maximum number of episodes
            pub max_episodes: Option<u32>,
            /// Maximum tool calls across all episodes
            pub max_tool_calls: Option<u32>,
            /// Maximum inference tokens
            pub max_tokens: Option<u64>,
            /// Maximum wall-clock duration
            pub max_duration: Option<Duration>,
            /// Allowed tool identifiers
            pub allowed_tools: Vec<ToolId>,
        }

        /// Scope of actions permitted by a lease.
        #[derive(Debug, Clone)]
        pub struct LeaseScope {
            /// Work identifiers this lease applies to
            pub work_ids: Vec<WorkId>,
            /// Action categories permitted
            pub permitted_actions: Vec<ActionCategory>,
            /// Environment restrictions
            pub environment: EnvironmentScope,
        }

    evidence_ids:
    - EVID-3004

  - id: CTR-3004
    name: "Ledger Event Schema"
    type: EVENT_SCHEMA
    versioning:
      scheme: SEMVER
      current_version: "0.1.0"
      compatibility_rules:
      - "New event types may be added in minor versions"
      - "Existing event payloads may gain optional fields"
      - "Event type discriminants must be stable"
    schemas:
    - id: SCH-3001
      path: "crates/apm2-holon/src/ledger/events.rs"
      format: RUST_TYPE
      description: "Ledger event types for holonic operations"
      inline_schema: |
        /// Event recorded in the holonic ledger.
        #[derive(Debug, Clone)]
        pub struct LedgerEvent {
            /// Unique event identifier
            pub id: EventId,
            /// Event timestamp
            pub timestamp: DateTime<Utc>,
            /// Associated work identifier
            pub work_id: WorkId,
            /// Holon that produced this event
            pub holon_id: HolonId,
            /// Event type and payload
            pub event_type: EventType,
            /// Serialized payload
            pub payload: serde_json::Value,
            /// Hash of previous event (chain linking)
            pub previous_hash: EventHash,
            /// Holon signature over canonical bytes
            pub signature: Signature,
        }

        /// Event type discriminant with associated data.
        #[derive(Debug, Clone)]
        pub enum EventType {
            // Work lifecycle events
            WorkCreated,
            WorkClaimed,
            WorkProgressed,
            WorkCompleted,
            WorkFailed,
            WorkEscalated,

            // Episode events
            EpisodeStarted,
            EpisodeCompleted,

            // Artifact events
            ArtifactEmitted,
            EvidencePublished,

            // Lease events
            LeaseIssued,
            LeaseRenewed,
            LeaseReleased,
            LeaseExpired,

            // Resource events
            BudgetConsumed,
            BudgetExhausted,
        }

    evidence_ids:
    - EVID-3002

  outputs:
    artifacts_produced:
    - id: OUT-3001
      name: "apm2-holon crate"
      path: "crates/apm2-holon/"
      format: "Rust crate"
    - id: OUT-3002
      name: "Holon trait and types"
      path: "crates/apm2-holon/src/holon/"
      format: "Rust modules"
    - id: OUT-3003
      name: "Work object implementation"
      path: "crates/apm2-holon/src/work/"
      format: "Rust modules"
    - id: OUT-3004
      name: "Lease and budget types"
      path: "crates/apm2-holon/src/resource/"
      format: "Rust modules"
    failure_modes:
    - id: FM-3001
      condition: "Lease expired during episode execution"
      detection: "Budget check at episode boundary"
      recovery: "Episode terminates with BudgetExhausted; work escalated"
    - id: FM-3002
      condition: "Work lifecycle state machine violation"
      detection: "Invalid transition attempt"
      recovery: "Transition rejected; error logged; escalate if persistent"
    - id: FM-3003
      condition: "Ledger event chain broken"
      detection: "Hash verification failure on append"
      recovery: "Reject append; alert; investigate ledger corruption"
