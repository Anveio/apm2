rfc_rollout_and_ops:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  rollout_plan:
    phases:
    - id: ROL-0001
      name: "Pre-Bootstrap: Manual Kernel Development"
      description: |
        Human developers implement the kernel using conventional tools and
        workflows. Evidence is captured manually but conforms to APM2 schemas.
        This phase proves the kernel architecture before self-hosting.
      steps:
      - "Initialize Rust workspace with cargo init"
      - "Implement ledger module with SQLite storage"
      - "Implement event schemas with prost"
      - "Implement reducer framework"
      - "Implement policy engine"
      - "Implement supervisor with session lifecycle"
      - "Implement black-box adapter"
      - "Write unit and integration tests"
      - "Capture evidence manually in evidence/ directory"
      guardrails:
      - "All commits signed with developer keys"
      - "CI runs tests on every PR"
      - "Code coverage > 80% for kernel modules"
      - "No unsafe Rust without explicit justification"
      rollback_steps:
      - "Revert to previous commit"
      - "Manual investigation and fix"
      evidence_ids:
      - EVID-1001
      - EVID-1002
      exit_criteria:
      - "Ledger can append and replay events"
      - "Reducers compute projections deterministically"
      - "Policy engine enforces default-deny"
      - "Supervisor manages session lifecycle"
      - "All unit tests pass"

    - id: ROL-0002
      name: "Supervised Self-Hosting: Human-Reviewed Changes"
      description: |
        The kernel supervises single agent sessions for development tasks.
        All merge decisions require human review. Evidence is captured by
        the system but humans validate gate receipts.
      steps:
      - "Deploy kernel with instrumented adapter for Claude Code"
      - "Configure policy to allow development operations"
      - "Run factory on small tickets with human oversight"
      - "Human reviews all diffs and evidence bundles"
      - "Human approves or rejects merge requests"
      - "Track success/failure rate and refine"
      guardrails:
      - "Human must approve every merge"
      - "Session entropy budget set conservatively"
      - "Automatic abort if evidence incomplete"
      - "Quarantine after 3 consecutive failures"
      rollback_steps:
      - "Human reverts merge"
      - "Analyze failure mode"
      - "Update policy or templates"
      evidence_ids:
      - EVID-0001
      - EVID-0002
      exit_criteria:
      - "10 successful supervised runs"
      - "Evidence bundles consistently valid"
      - "No policy violations requiring human intervention"
      - "Session entropy stays within budget"

    - id: ROL-0003
      name: "Autonomous Single-Agent: Evidence-Gated Merges"
      description: |
        Single agent can complete tickets autonomously with evidence-gated
        merges. Humans monitor but do not intervene unless the system
        escalates via NEEDS_ADJUDICATION.
      steps:
      - "Configure autonomous merge policy"
      - "Run factory on bounded tickets"
      - "System validates evidence and generates gate receipts"
      - "Merge proceeds if all gates pass"
      - "Human observes metrics and adjusts thresholds"
      guardrails:
      - "Merge blocked if evidence incomplete"
      - "Automatic rollback if post-merge tests fail"
      - "Alert on unusual patterns (high abort rate, entropy spikes)"
      - "Circuit breaker: pause after N consecutive failures"
      rollback_steps:
      - "Automatic git revert"
      - "Open investigation ticket"
      - "Fall back to ROL-0002 for affected work"
      evidence_ids:
      - EVID-0016
      - EVID-0017
      exit_criteria:
      - "5 autonomous ticket completions"
      - "Zero regressions from autonomous merges"
      - "Gate receipts correctly auto-generated"
      - "Rollback procedure verified"

    - id: ROL-0004
      name: "Multi-Agent Coordination: Lease-Based Parallel Work"
      description: |
        Multiple agents work in parallel with lease-based coordination.
        Adjudication resolves conflicts. System approaches full autonomy.
      steps:
      - "Enable concurrent session spawning"
      - "Configure lease registrar"
      - "Run factory with multiple concurrent agents"
      - "Monitor for lease conflicts"
      - "Configure adjudication for bounded choices"
      - "Track duplicate work rate"
      guardrails:
      - "At most one active lease per work_id"
      - "Lease conflicts trigger adjudication"
      - "Fanout bounded to prevent runaway spawning"
      - "Total budget caps across all sessions"
      rollback_steps:
      - "Revoke conflicting leases"
      - "Abort affected work items"
      - "Fall back to single-agent mode"
      evidence_ids:
      - EVID-0006
      - EVID-0018
      exit_criteria:
      - "20 concurrent runs with no duplicate work"
      - "Lease conflicts resolved deterministically"
      - "Adjudication fallbacks work correctly"
      - "Cost per merged change trending down"

  operability:
    runbooks:
    - id: RUN-0001
      name: "Ledger Corruption Recovery"
      trigger: "Hash chain verification fails on startup"
      steps:
      - "Stop all sessions"
      - "Run apm2 ledger verify to identify corruption point"
      - "If corruption localized: truncate ledger to last valid event"
      - "If corruption widespread: restore from backup"
      - "Replay reducers to rebuild projections"
      - "Resume operations"
      evidence_ids:
      - EVID-0004
    - id: RUN-0002
      name: "Session Quarantine Investigation"
      trigger: "Session quarantined after entropy budget exceeded"
      steps:
      - "Review session events with apm2 ledger inspect --session <id>"
      - "Identify pattern of errors or violations"
      - "Check if policy is too restrictive or agent is misbehaving"
      - "Adjust policy or report agent issue"
      - "Clear quarantine with apm2 session unquarantine <id>"
      evidence_ids:
      - EVID-0006
    - id: RUN-0003
      name: "Policy Update Deployment"
      trigger: "Policy rules need modification"
      steps:
      - "Edit policy YAML file"
      - "Run apm2 policy validate to check syntax"
      - "Deploy with apm2 policy reload"
      - "Verify POLICY.LOADED event in ledger"
      - "Monitor for unexpected denials"
      evidence_ids:
      - EVID-0003
    alarms:
    - id: ALM-0001
      name: "High session failure rate"
      condition: "session_failure_rate > 0.3 over 10 minutes"
      severity: WARNING
      response: "Investigate recent policy changes or agent issues"
    - id: ALM-0002
      name: "Ledger write latency spike"
      condition: "ledger_write_latency_p99 > 100ms"
      severity: WARNING
      response: "Check disk I/O; consider WAL checkpoint"
    - id: ALM-0003
      name: "Lease conflict rate elevated"
      condition: "lease_conflict_count > 5 in 1 hour"
      severity: WARNING
      response: "Check for split-brain or registrar issues"
    - id: ALM-0004
      name: "Policy violation detected"
      condition: "policy_violation_count > 0"
      severity: CRITICAL
      response: "Immediate investigation; session auto-quarantined"
    automated_response_notes:
    - "Session quarantine is automatic on entropy budget exceeded"
    - "Lease expiration triggers automatic release and failover"
    - "Adjudication timeout applies fallback policy automatically"
    - "Circuit breaker pauses spawning after N consecutive failures"

  observability:
    metrics:
    - name: "session_count"
      type: GAUGE
      description: "Number of active sessions"
      labels: ["adapter_type", "state"]
    - name: "session_entropy_consumed"
      type: COUNTER
      description: "Total entropy consumed by sessions"
      labels: ["actor_id"]
    - name: "tool_request_total"
      type: COUNTER
      description: "Total tool requests"
      labels: ["tool_name", "decision"]
    - name: "tool_request_duration_seconds"
      type: HISTOGRAM
      description: "Tool execution duration"
      labels: ["tool_name"]
    - name: "ledger_event_total"
      type: COUNTER
      description: "Total events written to ledger"
      labels: ["payload_type"]
    - name: "ledger_write_duration_seconds"
      type: HISTOGRAM
      description: "Ledger write latency"
      labels: []
    - name: "lease_active_count"
      type: GAUGE
      description: "Number of active leases"
      labels: []
    - name: "lease_conflict_total"
      type: COUNTER
      description: "Total lease conflicts"
      labels: ["resolution"]
    - name: "work_completed_total"
      type: COUNTER
      description: "Total work items completed"
      labels: ["work_type", "outcome"]
    - name: "evidence_published_total"
      type: COUNTER
      description: "Total evidence artifacts published"
      labels: ["category"]
    - name: "adjudication_total"
      type: COUNTER
      description: "Total adjudication requests"
      labels: ["type", "outcome"]
    logs:
    - name: "kernel_events"
      format: "JSON structured logs via tracing"
      retention: "30 days"
      classification: INTERNAL
    - name: "session_transcripts"
      format: "Agent session I/O"
      retention: "90 days"
      classification: RESTRICTED
    traces:
    - name: "request_trace"
      description: "End-to-end trace from tool request to response"
      span_names:
      - "tool_request_received"
      - "policy_evaluation"
      - "tool_execution"
      - "response_sent"
    - name: "work_lifecycle_trace"
      description: "Trace of work item from open to complete"
      span_names:
      - "work_opened"
      - "lease_issued"
      - "session_started"
      - "work_in_progress"
      - "evidence_published"
      - "gate_reviewed"
      - "work_completed"
    audit_events:
    - name: "POLICY.VIOLATION"
      description: "Agent attempted unauthorized action"
      retention: "1 year"
      alerting: true
    - name: "LEASE.CONFLICT"
      description: "Duplicate lease claim detected"
      retention: "1 year"
      alerting: true
    - name: "ADJ.TIMEOUT"
      description: "Adjudication deadline exceeded"
      retention: "1 year"
      alerting: false
    - name: "KEY.ROTATED"
      description: "Cryptographic key rotation"
      retention: "1 year"
      alerting: false
