rfc_trust_boundaries:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  boundaries:
  - id: TB-0001
    name: "Kernel-to-Agent Boundary (Syscall Mediation)"
    description: |
      The primary security boundary between the trusted kernel and untrusted
      agent sessions. All agent side effects must cross this boundary via
      the syscall mediation protocol. The adapter enforces this boundary.
    actors:
    - id: ACTOR-KERNEL
      name: "APM2 Kernel (Supervisor)"
      trust_level: TRUSTED
      description: "Executes policy decisions, writes to ledger, manages sessions"
    - id: ACTOR-AGENT
      name: "Agent Session"
      trust_level: UNTRUSTED
      description: "Probabilistic inference engine; may attempt unauthorized actions"
    entrypoints:
    - id: EP-0001
      name: "ToolRequest submission"
      protocol: "Protobuf over stdin/stdout or Unix socket"
      authentication: "Session token bound to lease"
      authorization: "PolicyEngine evaluates each request"
    - id: EP-0002
      name: "ProgressSignal emission"
      protocol: "Protobuf heartbeat messages"
      authentication: "Session token"
      authorization: "Read-only signal; always accepted"
    data_flows:
    - id: DF-0001
      name: "Tool request flow"
      source: ACTOR-AGENT
      destination: ACTOR-KERNEL
      data_classification: INTERNAL
      description: "Agent submits ToolRequest; kernel evaluates and responds"
    - id: DF-0002
      name: "Tool response flow"
      source: ACTOR-KERNEL
      destination: ACTOR-AGENT
      data_classification: INTERNAL
      description: "Kernel returns ToolResponse with result or denial"
    - id: DF-0003
      name: "Work context provisioning"
      source: ACTOR-KERNEL
      destination: ACTOR-AGENT
      data_classification: INTERNAL
      description: "Kernel provides spec snapshot and policy context to agent"
    authn_authz:
      authn: "Session tokens are generated at session start and bound to actor_id + lease_id"
      authz: "PolicyEngine evaluates ToolRequest against policy rules, budgets, and lease scope"
    risks:
    - id: RSK-TB-0001
      statement: "Agent attempts to bypass mediation by direct OS calls"
      mitigation: "Adapter runs agent in restricted environment; seccomp profile blocks direct syscalls"
    - id: RSK-TB-0002
      statement: "Agent crafts malformed ToolRequest to exploit parser"
      mitigation: "Strict protobuf schema validation; fuzz testing of parser"
    - id: RSK-TB-0003
      statement: "Agent exhausts resources within allowed budget"
      mitigation: "Budget tracking at policy level; session entropy budget limits cumulative cost"
    evidence_ids:
    - EVID-0003
    - EVID-0013
    - EVID-0014

  - id: TB-0002
    name: "Agent-to-External-System Boundary"
    description: |
      The boundary between agent-initiated actions and external systems (Git,
      CI/CD, inference providers). All external access is mediated through
      the kernel's syscall layer; the agent never has direct credentials.
    actors:
    - id: ACTOR-AGENT
      name: "Agent Session (via Kernel)"
      trust_level: UNTRUSTED
      description: "Requests external operations through kernel mediation"
    - id: ACTOR-GIT
      name: "Git Repository Host"
      trust_level: EXTERNAL
      description: "Source control system; operations require authenticated API calls"
    - id: ACTOR-CI
      name: "CI/CD Environment"
      trust_level: EXTERNAL
      description: "Build and test execution environment"
    - id: ACTOR-INFERENCE
      name: "Inference Provider"
      trust_level: EXTERNAL
      description: "LLM API or local model runtime"
    entrypoints:
    - id: EP-0001
      name: "Git operations (clone, fetch, push)"
      protocol: "HTTPS or SSH via kernel subprocess"
      authentication: "Kernel holds credentials; agent never sees them"
      authorization: "Policy allowlist specifies permitted repos and operations"
    - id: EP-0002
      name: "CI/CD trigger"
      protocol: "Subprocess or API call"
      authentication: "Kernel holds CI tokens"
      authorization: "Policy specifies permitted workflows"
    - id: EP-0003
      name: "Inference call"
      protocol: "HTTPS API or local socket"
      authentication: "Kernel holds API keys or local auth"
      authorization: "Policy specifies token budgets and model allowlists"
    data_flows:
    - id: DF-0001
      name: "Repository data flow"
      source: ACTOR-GIT
      destination: ACTOR-KERNEL
      data_classification: INTERNAL
      description: "Source code fetched into mediated workspace"
    - id: DF-0002
      name: "Inference request/response"
      source: ACTOR-KERNEL
      destination: ACTOR-INFERENCE
      data_classification: RESTRICTED
      description: "Prompts may contain code; responses are logged"
    authn_authz:
      authn: "Kernel manages all external credentials; agents submit requests, not credentials"
      authz: "Policy engine evaluates external access requests against allowlists"
    risks:
    - id: RSK-TB-0001
      statement: "Credentials leaked to agent session"
      mitigation: "Credentials never passed to agent; kernel performs authenticated calls"
    - id: RSK-TB-0002
      statement: "Agent exfiltrates data via inference API"
      mitigation: "Inference requests logged and classified; egress policy limits data"
    - id: RSK-TB-0003
      statement: "Malicious code pushed to repository"
      mitigation: "Review gate required before merge; evidence bundle validation"
    evidence_ids:
    - EVID-0003
    - EVID-0013

  - id: TB-0003
    name: "Node-to-Node Federation Boundary (Stub)"
    description: |
      The boundary between federated APM2 nodes. Nodes replicate ledger segments
      and exchange control commands. This boundary is STUBBED in RFC-0001;
      full implementation is deferred to RFC-0002.
    actors:
    - id: ACTOR-LOCAL-NODE
      name: "Local APM2 Node"
      trust_level: TRUSTED
      description: "The local kernel instance"
    - id: ACTOR-PEER-NODE
      name: "Peer APM2 Node"
      trust_level: SEMI_TRUSTED
      description: "Federated peer; trusted for replication, not for local execution"
    entrypoints:
    - id: EP-0001
      name: "Federation link (QUIC)"
      protocol: "QUIC with TLS 1.3"
      authentication: "Mutual TLS with node certificates"
      authorization: "Explicit peer allowlist; no implicit trust"
    data_flows:
    - id: DF-0001
      name: "Ledger replication"
      source: ACTOR-PEER-NODE
      destination: ACTOR-LOCAL-NODE
      data_classification: INTERNAL
      description: "Signed ledger events replicated by cursor"
    - id: DF-0002
      name: "Control commands"
      source: ACTOR-PEER-NODE
      destination: ACTOR-LOCAL-NODE
      data_classification: INTERNAL
      description: "Bounded control messages (lease queries, health checks)"
    authn_authz:
      authn: "Mutual TLS with Ed25519 node identity certificates"
      authz: "Peer must be in explicit allowlist; commands validated against schema"
    risks:
    - id: RSK-TB-0001
      statement: "Malicious peer sends forged ledger events"
      mitigation: "All events verified by signature; invalid signatures rejected"
    - id: RSK-TB-0002
      statement: "Peer floods with replication traffic"
      mitigation: "Rate limiting; priority queues; traffic shaping"
    evidence_ids:
    - EVID-0007
    stub_note: |
      This boundary is defined for future compatibility but NOT implemented in
      RFC-0001. The federation link trait will have a no-op implementation.
      Full implementation is deferred to RFC-0002.

  - id: TB-0004
    name: "Ledger Integrity Boundary"
    description: |
      The integrity boundary protecting the ledger from tampering. All writes
      are hash-chained and signed. Verification can detect any modification.
    actors:
    - id: ACTOR-LEDGER-WRITER
      name: "Ledger Module"
      trust_level: TRUSTED
      description: "Only component that writes to ledger storage"
    - id: ACTOR-LEDGER-READER
      name: "Reducers and Verifiers"
      trust_level: TRUSTED
      description: "Read and verify ledger integrity"
    - id: ACTOR-STORAGE
      name: "SQLite Database"
      trust_level: STORAGE
      description: "Passive storage; assumed to preserve bytes but not verify integrity"
    entrypoints:
    - id: EP-0001
      name: "Event append"
      protocol: "Internal Rust API"
      authentication: "Module boundary (compile-time)"
      authorization: "Only Ledger module can call append"
    - id: EP-0002
      name: "Event read"
      protocol: "Internal Rust API"
      authentication: "Module boundary"
      authorization: "Any module can read; integrity verified on read"
    data_flows:
    - id: DF-0001
      name: "Event write"
      source: ACTOR-LEDGER-WRITER
      destination: ACTOR-STORAGE
      data_classification: INTERNAL
      description: "Signed, hash-chained event written to SQLite"
    - id: DF-0002
      name: "Event read"
      source: ACTOR-STORAGE
      destination: ACTOR-LEDGER-READER
      data_classification: INTERNAL
      description: "Events read and verified by reducers"
    authn_authz:
      authn: "Ed25519 signatures on each event; node signing key"
      authz: "Write restricted to Ledger module; read open to all kernel modules"
    risks:
    - id: RSK-TB-0001
      statement: "Attacker modifies SQLite file directly"
      mitigation: "Hash-chain verification detects any modification"
    - id: RSK-TB-0002
      statement: "Signing key compromised"
      mitigation: "Key stored with 0600 permissions; rotation mechanism; key history preserved"
    - id: RSK-TB-0003
      statement: "Replay attack with old valid events"
      mitigation: "Sequence numbers and previous-hash linking prevent insertion"
    evidence_ids:
    - EVID-0004
    - EVID-1004
