rfc_problem_and_imports:
  schema_version: "2026-01-30"
  template_version: "2026-01-23"

  problem_statement:
    summary: |
      xtask commands bypass the daemon control plane, allowing agents and operators
      to execute operations without capability minting, lease validation, or receipt-
      backed orchestration. This creates an adversarial surface where FAC (PRD-0009)
      guarantees can be circumvented at the execution layer.

    north_star: |
      The daemon is the sole control plane for work orchestration. All episode spawns,
      tool invocations, and state transitions flow through authenticated daemon IPC
      with policy-resolved capabilities and receipt-backed evidence.

    current_state:
      - "xtask commands can directly invoke GitHub operations, tool execution, and work state mutations without daemon mediation"
      - "No IPC authentication boundary exists between agents and privileged operations"
      - "Capabilities can be requested by callers rather than minted by policy"
      - "Sessions may have access to credentials that should be broker-mediated"
      - "No mechanical enforcement of Separation of Duties (SoD) at execution time"

    failure_modes:
      - id: FM-0001
        name: "Direct xtask bypass of control plane"
        description: |
          Agents invoke xtask commands directly, bypassing daemon IPC authentication
          and capability minting. Operations execute with ambient authority.
        impact:
          - "FAC gate requirements can be circumvented"
          - "No audit trail of capability grants"
          - "SoD violations undetected"

      - id: FM-0002
        name: "Requester-supplied capabilities"
        description: |
          ClaimWork patterns allow requesters to specify desired capabilities,
          violating the principle that capabilities are minted by policy.
        impact:
          - "Privilege escalation via capability request manipulation"
          - "Policy bypass through over-permissive capability claims"

      - id: FM-0003
        name: "Credentials in session scope"
        description: |
          Sessions may inherit or access credentials (GitHub tokens, API keys)
          directly, violating OCAP containment principles.
        impact:
          - "Credential theft via compromised agent"
          - "Lateral movement through credential reuse"

      - id: FM-0004
        name: "Missing daemon crash recovery"
        description: |
          If daemon crashes mid-episode, active sessions may be orphaned without
          proper lease revocation or cleanup.
        impact:
          - "Orphaned sessions continue operating without valid lease"
          - "State inconsistency between ledger and running processes"

  imports:
    from_prd:
      prd_id: PRD-0010
      requirements:
        - id: REQ-DCP-0001
          source_id: REQ-0001
          title: "IPC Privilege Separation"
          statement: |
            apm2-daemon MUST separate IPC endpoints into privileged (operator-only) and
            session-scoped (bound to session_id) categories; agents MUST NOT be able to
            call privileged endpoints directly.
          acceptance_criteria:
            - "Privileged endpoints require operator credential"
            - "Session-scoped endpoints bound to authenticated session_id"
            - "Denied privilege escalation returns generic PERMISSION_DENIED"

        - id: REQ-DCP-0002
          source_id: REQ-0002
          title: "PolicyResolvedForChangeSet Precondition"
          statement: |
            apm2-daemon SpawnEpisode MUST block until PolicyResolvedForChangeSet exists
            for the specified work_id; episode spawn without policy resolution MUST be
            rejected.
          acceptance_criteria:
            - "SpawnEpisode verifies PolicyResolvedForChangeSet in ledger"
            - "Missing policy resolution emits POLICY_RESOLUTION_MISSING"
            - "Adversarial test ADV-004 is rejected"

        - id: REQ-DCP-0003
          source_id: REQ-0003
          title: "GateLeaseIssued Precondition"
          statement: |
            apm2-daemon SpawnEpisode for GATE_EXECUTOR roles MUST require valid
            GateLeaseIssued matching (work_id, gate_id, changeset_digest, executor_actor_id);
            spawn without valid lease MUST be rejected.
          acceptance_criteria:
            - "GATE_EXECUTOR spawn requires valid GateLeaseIssued"
            - "Lease binds executor to specific changeset"
            - "Missing or mismatched lease emits GATE_LEASE_MISSING"

        - id: REQ-DCP-0004
          source_id: REQ-0004
          title: "Zero Credentials in Sessions"
          statement: |
            apm2-daemon MUST provide sessions with ephemeral handles only; sessions MUST
            NOT have direct access to credentials; all authenticated operations MUST be
            broker-mediated.
          acceptance_criteria:
            - "EpisodeSpawned returns ephemeral_handle, not credentials"
            - "GitHub, API keys, SSH keys held by daemon broker"
            - "Session requests tool calls; broker mediates"

        - id: REQ-DCP-0005
          source_id: REQ-0005
          title: "Context Firewall Enforcement"
          statement: |
            apm2-daemon tool broker MUST enforce context firewall with deny + terminate
            semantics; reads outside ContextPack allowlist MUST terminate session
            immediately, not log and continue.
          acceptance_criteria:
            - "ToolDecided=DENY emitted for allowlist violations"
            - "SessionTerminated with rationale=CONTEXT_FIREWALL_VIOLATION"
            - "Session process receives SIGTERM after denial"

        - id: REQ-DCP-0006
          source_id: REQ-0006
          title: "SoD Custody Domain Enforcement"
          statement: |
            apm2-daemon MUST enforce Separation of Duties by rejecting gate executor
            spawn when executor custody domain overlaps with author custody domains
            for the changeset.
          acceptance_criteria:
            - "SpawnEpisode validates custody domain separation"
            - "LeaseIssueDenied event emitted with reason=SOD_VIOLATION"
            - "CLI returns non-zero exit code with diagnostic"

        - id: REQ-DCP-0007
          source_id: REQ-0007
          title: "Signed State Transitions"
          statement: |
            All state transitions through apm2-daemon MUST emit Ed25519 signed events
            to ledger with domain-separated prefixes; unsigned events MUST be rejected
            at ledger ingestion.
          acceptance_criteria:
            - "WorkClaimed, EpisodeSpawned, ToolDecided, ToolExecuted signed"
            - "Domain-separated prefixes prevent cross-context replay"
            - "Unsigned events rejected at ledger ingestion"

        - id: REQ-DCP-0008
          source_id: REQ-0008
          title: "IPC Authentication"
          statement: |
            apm2-daemon IPC MUST authenticate all clients via Unix socket peer
            credentials (SO_PEERCRED) and issue per-connection capability tokens;
            unauthenticated requests MUST be rejected.
          acceptance_criteria:
            - "SO_PEERCRED validates peer UID/GID"
            - "Per-client capability tokens issued at connection"
            - "Unauthenticated requests rejected"

        - id: REQ-DCP-0009
          source_id: REQ-0009
          title: "Spawn Acknowledgment Latency"
          statement: |
            apm2-daemon spawn_ack_latency (session_id returned) MUST be <100ms p99;
            measured on local Unix socket IPC with daemon warm.
          acceptance_criteria:
            - "Benchmark shows <100ms p99 spawn_ack_latency"
            - "Measured with warm daemon on local socket"

        - id: REQ-DCP-0010
          source_id: REQ-0010
          title: "Session Ready Latency"
          statement: |
            apm2-daemon session_ready_latency (pack sealed, policy checked, sandbox
            ready) MUST be <2s p99.
          acceptance_criteria:
            - "Benchmark shows <2s p99 session_ready_latency"
            - "Includes pack sealing, policy check, sandbox setup"

        - id: REQ-DCP-0011
          source_id: REQ-0011
          title: "Tool Mediation Overhead"
          statement: |
            apm2-daemon tool mediation overhead (excluding tool execution) MUST be
            <5ms p50.
          acceptance_criteria:
            - "Benchmark shows <5ms p50 mediation overhead"
            - "Excludes actual tool execution time"

        - id: REQ-DCP-0012
          source_id: REQ-0012
          title: "Daemon Health Metrics"
          statement: |
            apm2-daemon MUST expose Prometheus-compatible metrics for operational
            monitoring.
          acceptance_criteria:
            - "apm2_daemon_sessions_active metric exposed"
            - "apm2_daemon_tool_mediation_latency_seconds histogram exposed"
            - "apm2_daemon_ipc_requests_total counter exposed"
            - "apm2_daemon_capability_grants_total counter exposed"

        - id: REQ-DCP-0013
          source_id: REQ-0013
          title: "Daemon Crash Recovery"
          statement: |
            apm2-daemon restart MUST NOT orphan running episodes; sessions MUST
            receive LEASE_REVOKED signal within 5s of daemon recovery.
          acceptance_criteria:
            - "LEASE_REVOKED signal sent to all sessions within 5s"
            - "SessionTerminated events recorded in ledger"
            - "No orphaned processes after recovery"

    from_rfc:
      - rfc_id: RFC-0015
        version: "v4.1+"
        concepts_imported:
          - name: PolicyResolvedForChangeSet
            usage: "Precondition for episode spawn; daemon verifies existence before spawning"
          - name: GateLeaseIssued
            usage: "Precondition for gate executor spawn; binds executor to changeset"
          - name: "Signed receipts"
            usage: "All state transitions emit signed events; receipt-backed orchestration"
          - name: "Key custody separation"
            usage: "SoD enforcement via custody domain checks"
          - name: "Context firewall rules"
            usage: "Tool mediation enforces CTX-ALLOWLIST-001, CTX-CONSUME-FATAL-001"
