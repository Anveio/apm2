rfc_trust_boundaries:
  schema_version: "2026-01-30"
  template_version: "2026-01-23"

  trust_model:
    principals:
      - id: PRINCIPAL-OPERATOR
        name: "Operator"
        trust_level: HIGH
        description: |
          Human operator or automation with operator credentials.
          Can access privileged IPC endpoints.
        capabilities:
          - "ClaimWork"
          - "SpawnEpisode"
          - "IssueCapability"
          - "Shutdown"

      - id: PRINCIPAL-AGENT
        name: "Agent Session"
        trust_level: LOW
        description: |
          AI agent running in a spawned session. Untrusted by default.
          Can only access session-scoped IPC endpoints.
        capabilities:
          - "RequestTool"
          - "EmitEvent"
          - "PublishEvidence"
          - "StreamTelemetry"

      - id: PRINCIPAL-DAEMON
        name: "Daemon"
        trust_level: SYSTEM
        description: |
          The apm2-daemon process. Trusted execution substrate.
          Holds credentials, mediates tools, enforces policy.

      - id: PRINCIPAL-GOVERNANCE
        name: "Kernel Governance Holon"
        trust_level: SYSTEM
        description: |
          HOLON-KERNEL-GOVERNANCE. Provides policy resolution.
          Daemon calls governance but does not embed its logic.

  trust_boundaries:
    - id: TB-001
      name: "IPC Authentication Boundary"
      description: |
        Unix domain socket with peer credential validation.
        Separates unauthenticated callers from daemon services.
      crossings:
        - from: "External process"
          to: "Daemon IPC handler"
          authentication: "SO_PEERCRED (UID/GID verification)"
          authorization: "Per-connection capability token"
      threats:
        - threat_id: TH-001
          name: "Unauthenticated IPC access"
          mitigation: "SO_PEERCRED rejects connections from unknown peers"
        - threat_id: TH-002
          name: "UID spoofing in containers"
          mitigation: "Require --userns=host for container deployments"

    - id: TB-002
      name: "Privilege Separation Boundary"
      description: |
        Separates privileged endpoints (operator-only) from session-scoped
        endpoints (bound to session_id).
      crossings:
        - from: "Agent session"
          to: "Privileged endpoint"
          authentication: "Blocked"
          authorization: "PERMISSION_DENIED returned"
      threats:
        - threat_id: TH-003
          name: "Privilege escalation via IPC"
          mitigation: "Agent sessions cannot reach privileged handlers"
        - threat_id: TH-004
          name: "Endpoint enumeration via error messages"
          mitigation: "Generic PERMISSION_DENIED without endpoint names"

    - id: TB-003
      name: "Credential Isolation Boundary"
      description: |
        Separates session scope from credential access.
        Credentials (GitHub tokens, API keys, SSH keys) held by daemon only.
      crossings:
        - from: "Agent session"
          to: "Authenticated operation"
          authentication: "Broker-mediated"
          authorization: "Capability manifest validation"
      threats:
        - threat_id: TH-005
          name: "Credential theft via compromised agent"
          mitigation: "Sessions never see raw credentials"
        - threat_id: TH-006
          name: "Lateral movement via credential reuse"
          mitigation: "Ephemeral handles only; no credential persistence in session"

    - id: TB-004
      name: "Context Firewall Boundary"
      description: |
        Enforces read/write allowlists from ContextPack.
        Violations terminate session immediately.
      crossings:
        - from: "Agent session"
          to: "File system / external resources"
          authentication: "Session-scoped"
          authorization: "ContextPack allowlist validation"
      threats:
        - threat_id: TH-007
          name: "Context escape via unauthorized read"
          mitigation: "Reads outside allowlist emit DENY + terminate"
        - threat_id: TH-008
          name: "Data exfiltration via writes"
          mitigation: "Write operations gated by capability manifest"

  threat_mitigations:
    - id: MIT-001
      threat_id: TH-001
      control: "SEC-CTRL-0001 (Unix socket peer credential validation)"
      effectiveness: HIGH
      residual_risk: "UID remapping in containers may bypass"

    - id: MIT-002
      threat_id: TH-002
      control: "CNS-0009 (Container UID mapping requirement)"
      effectiveness: MEDIUM
      residual_risk: "Deployment misconfiguration possible"

    - id: MIT-003
      threat_id: TH-003
      control: "INV-0001 (Agent cannot execute privileged operations)"
      effectiveness: HIGH
      residual_risk: "Bug in privilege separation logic"

    - id: MIT-004
      threat_id: TH-004
      control: "CNS-0010 (Generic error messages)"
      effectiveness: HIGH
      residual_risk: "Timing side channels"

    - id: MIT-005
      threat_id: TH-005
      control: "SEC-CTRL-0004 (Credential broker isolation)"
      effectiveness: HIGH
      residual_risk: "Daemon process compromise"

    - id: MIT-006
      threat_id: TH-006
      control: "CNS-0004 (Ephemeral handles only)"
      effectiveness: HIGH
      residual_risk: "Handle leakage via side channels"

    - id: MIT-007
      threat_id: TH-007
      control: "SEC-CTRL-0003 (Context firewall enforcement)"
      effectiveness: HIGH
      residual_risk: "Race condition in deny/terminate"

    - id: MIT-008
      threat_id: TH-008
      control: "Capability manifest write_allowlist"
      effectiveness: HIGH
      residual_risk: "Overly permissive policy configuration"

  security_invariants:
    - invariant_id: INV-0001
      statement: "An agent cannot execute privileged IPC operations"
      enforcement: "IPC authentication + endpoint classification"

    - invariant_id: INV-0002
      statement: "A session cannot access credentials directly"
      enforcement: "Daemon tool broker holds credentials"

    - invariant_id: INV-0003
      statement: "A gate executor cannot produce GateOutcome without valid lease"
      enforcement: "GateOutcome validation requires lease match"

    - invariant_id: INV-0004
      statement: "Context firewall violations result in immediate session termination"
      enforcement: "SessionTerminated emitted; SIGTERM to process"

    - invariant_id: INV-0005
      statement: "All receipts are Ed25519 signed with domain-separated prefixes"
      enforcement: "Signature verification on ledger ingestion"

    - invariant_id: INV-0006
      statement: "Daemon restart recovers active sessions within 5s"
      enforcement: "Session manager tracks sessions; recovery emits LEASE_REVOKED"

  adversarial_tests:
    - id: ADV-001
      name: "Agent calls ClaimWork"
      description: "Agent session attempts to call privileged ClaimWork endpoint"
      expected_outcome: "PERMISSION_DENIED; session continues"
      invariant_tested: INV-0001

    - id: ADV-002
      name: "Agent calls SpawnEpisode"
      description: "Agent session attempts to spawn another episode"
      expected_outcome: "PERMISSION_DENIED; session continues"
      invariant_tested: INV-0001

    - id: ADV-003
      name: "Agent reads outside context pack"
      description: "Agent session requests read of file outside ContextPack allowlist"
      expected_outcome: "ToolDecided=DENY; SessionTerminated; SIGTERM sent"
      invariant_tested: INV-0004

    - id: ADV-004
      name: "GateOutcome without lease"
      description: "Attempt to emit GateOutcome for gate without valid lease"
      expected_outcome: "GATE_LEASE_MISSING error; outcome rejected"
      invariant_tested: INV-0003

    - id: ADV-005
      name: "ClaimWork with capability parameters"
      description: "Operator attempts ClaimWork with requester-supplied capabilities"
      expected_outcome: "CAPABILITY_REQUEST_REJECTED; only (actor_id, role) accepted"
      constraint_tested: CNS-0001

    - id: ADV-006
      name: "SoD violation - same domain author+reviewer"
      description: "Attempt to spawn gate executor with overlapping custody domain"
      expected_outcome: "LeaseIssueDenied with reason=SOD_VIOLATION"
      constraint_tested: CNS-0006

    - id: ADV-007
      name: "Forge unsigned receipt"
      description: "Attempt to ingest unsigned event to ledger"
      expected_outcome: "Event rejected at ledger ingestion"
      invariant_tested: INV-0005

    - id: ADV-008
      name: "xtask direct execution post-removal"
      description: "Attempt to run xtask command after Phase 3 removal"
      expected_outcome: "Command not found; proper apm2 CLI command suggested"
      tests: "xtask deprecation complete"
