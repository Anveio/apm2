prd_solution_overview:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  proposed_solution:
    overview: |
      Context-as-Code (CAC) makes context the authoritative program in an agent-native factory.
      The solution provides a canonical context substrate (CAC-JSON), patch-first authoring
      with replay protection, hermetic consumption with deterministic reads, and target
      interoperability through compiled payloads. All state transitions are recorded as
      signed kernel messages referencing immutable hashes. The key insight is that if
      context is complete and correct, code can be generated deterministically; therefore,
      the highest-leverage engineering work is to make context machine-native, canonical,
      and enforceable.
    key_components:
      - name: CAC Canonicalizer
        component_id: CAC-CANON
        type: rust_library
        description: |
          Parses CAC-JSON without floats and with strict limits. Emits canonical bytes
          deterministically following a JCS-like canonicalization scheme. Exposes
          test-vector based verification for cross-platform determinism.
        interfaces:
          - "canonicalize(bytes) -> canonical_bytes"
          - "hash(canonical_bytes) -> b3-256"
      - name: CAC Validator
        component_id: CAC-VALID
        type: rust_library
        description: |
          Validates artifacts against JSON Schemas (draft 2020-12 minimum). Enforces
          validator profile with unknown fields rejected and size/depth bounds.
          Validates PatchRecord streams and enforces typed-quantity constraints.
      - name: Bootstrap Schema Bundle
        component_id: CAC-BOOTSTRAP
        type: binary_embedded_data
        description: |
          Embeds a minimal schema bundle pinned by hash in the apm2 binary (Phase-0
          trust root). Exposes read-only bootstrap manifest to validator and admission
          pipeline. Rejects any patch or artifact that modifies bootstrap stable IDs.
      - name: Patch Engine
        component_id: CAC-PATCH
        type: rust_library
        description: |
          Applies JSON Patch / Merge Patch to canonical JSON trees. Enforces replay
          protection via expected_base_hash. Emits ChangeSetReport for review and
          compaction.
      - name: DCP Index / Resolver
        component_id: CAC-DCP
        type: projection_service_or_library
        description: |
          Resolves stable_id to pinned content_hash and schema refs. Provides
          deterministic reads for consumption mode via ArtifactFetch. Reconstructs
          index from ledger events. Provides dependency graph closure for pack
          compilation.
      - name: Context Compiler
        component_id: CAC-COMPILER
        type: service_or_library
        description: |
          Compiles ContextPackSpec into ContextPackManifest with derived artifacts.
          Deep-pins transitive dependencies to produce self-contained packs. Compiles
          target payloads per TargetProfile. Emits receipts and evidence.
      - name: APM2 CLI CAC Commands
        component_id: CAC-CLI
        type: cli_surface
        description: |
          Machine-readable CLI commands for CAC operations. All commands are listed
          in capability manifest with declared inputs/outputs.
        commands:
          - "apm2 cac lint"
          - "apm2 cac fmt"
          - "apm2 cac apply-patch"
          - "apm2 pack compile"
          - "apm2 export --profile <target>"
          - "apm2 capabilities --json"
          - "apm2 selftest"
      - name: Selftest/AAT Harness
        component_id: CAC-AAT
        type: test_harness
        description: |
          Runs hermetic acceptance tests for CLI contracts, tool protocol, and export
          determinism. Emits structured AATReceipt stored in CAS and referenced in
          ledger. Gates critical cutovers and agent planning.
    external_dependencies:
      - "APM2 Kernel: Signed hash-chained ledger, KernelEvent families, tool protocol."
      - "Content-Addressed Store (CAS): BLAKE3-256 hashed immutable blobs."
      - "Existing APM2 evidence module for provenance and evidence publishing."
  system_model:
    core_components:
      - id: COMP-KERNEL
        name: Holonic Kernel
        responsibilities:
          - Enforce policy, budgets, and leases.
          - Persist signed events in an append-only ledger.
          - Mediate tool execution (default-deny) and record tool events.
          - Publish evidence artifacts to CAS and emit evidence events.
      - id: COMP-CAS
        name: Content-Addressed Store (CAS)
        hash_algorithm: "BLAKE3-256"
        responsibilities:
          - Store immutable blobs addressed by cryptographic content hashes.
          - Verify integrity on store and retrieve.
      - id: COMP-LEDGER
        name: Ledger
        responsibilities:
          - Append-only, hash-chained log of signed kernel events.
          - Source of truth for all state transitions and provenance.
      - id: COMP-DCP
        name: Deterministic Content Plane (DCP)
        note: |
          DCP is implemented as an index/projection over immutable artifacts and
          ledger events; not an independent mutable source of truth.
        responsibilities:
          - Provide stable-ID addressing for normative artifacts.
          - Enable deterministic, preauthorized reads by stable ID in consumption mode.
          - Track dependency edges between artifacts and expose graph closure for pack compilation.
      - id: COMP-CAC-REGISTRY
        name: CAC Artifact and Schema Registry
        responsibilities:
          - Define artifact kinds and schema IDs.
          - Validate and canonicalize artifacts for admission.
          - Ship and verify bootstrap schema bundle pinned by hash.
          - Manage schema evolution rules and compatibility.
    entities:
      - id: ENT-ARTIFACT
        name: ControlArtifact
        definition: A normative CAC-JSON document that influences holonic behavior.
        identity:
          - stable_id
          - content_hash
          - schema_ref
      - id: ENT-SCHEMA
        name: SchemaDefinition
        definition: A versioned schema (JSON Schema) used to validate a ControlArtifact kind.
      - id: ENT-PATCH
        name: PatchRecord
        definition: A single machine-authored patch operation with replay protection and provenance.
      - id: ENT-PACK
        name: ContextPack
        definition: A bounded set of stable-ID addressed artifacts for hermetic consumption.
      - id: ENT-CAP
        name: CapabilityManifest
        definition: A machine-readable declaration of what the CLI/kernel actually supports.
      - id: ENT-TARGET
        name: TargetProfile
        definition: A machine-readable profile defining budgets, rendering, and delivery constraints.
      - id: ENT-RECEIPT
        name: Receipt
        definition: A structured evidence record proving an action occurred and met its contract.
      - id: ENT-RUN-RECEIPT
        name: RunReceipt
        definition: A run receipt capturing context pack sufficiency, misses, and budget usage.
  artifact_kinds:
    registry_version: "1.0.0"
    kinds:
      - kind_id: schema.definition
        schema_id: cac.schema_definition.v1
        normative: true
        consume_allowed: true
        purpose: Defines schemas used to validate other artifacts.
      - kind_id: policy.profile
        schema_id: cac.policy_profile.v1
        normative: true
        consume_allowed: true
        purpose: Defines policy rules for tools, reads, budgets, and consumption hermeticity.
      - kind_id: budget.profile
        schema_id: cac.budget_profile.v1
        normative: true
        consume_allowed: true
        purpose: Defines budgets/limits used in leases and tool calls.
      - kind_id: holon.contract
        schema_id: cac.holon_contract.v1
        normative: true
        consume_allowed: true
        purpose: Defines holon roles, modes, inputs/outputs, and allowed operations.
      - kind_id: skill.spec
        schema_id: cac.skill_spec.v1
        normative: true
        consume_allowed: true
        purpose: Defines agent skill/instruction bundles as machine-native context.
      - kind_id: target.profile
        schema_id: cac.target_profile.v1
        normative: true
        consume_allowed: true
        purpose: Defines rendering, retrieval, and delivery constraints.
      - kind_id: canonicalizer.vectors
        schema_id: cac.canonicalizer_vectors.v1
        normative: true
        consume_allowed: true
        purpose: Governed canonicalization test vectors pinned in the bootstrap trust root.
      - kind_id: capabilities.manifest
        schema_id: cac.capabilities_manifest.v1
        normative: true
        consume_allowed: true
        purpose: Declares what the CLI/kernel actually supports.
      - kind_id: typed_quantity.definition
        schema_id: cac.typed_quantity.v1
        normative: true
        consume_allowed: true
        purpose: |
          Canonical schema for quantities with explicit units. All artifact schemas
          referencing quantities (budgets, timeouts, costs, probabilities) MUST
          use $ref to this schema.
        schema_fields:
          value: "int64 (REQUIRED)"
          unit: "enum [TOKENS, BYTES, SECONDS, MILLISECONDS, PROBABILITY, COUNT] (REQUIRED)"
          confidence: "probability (OPTIONAL, for uncertain quantities)"
      - kind_id: context_pack.spec
        schema_id: cac.context_pack_spec.v1
        normative: true
        consume_allowed: true
        purpose: Defines which stable IDs constitute a ContextPack.
        dependency_trust_boundary:
          description: |
            Pack specs referencing stable_ids MUST capture resolved hashes at review time
            via dependency_review_hash field. Compilation warns/fails if resolved hash
            differs from reviewed hash, preventing timing-based injection attacks.
            Additionally, provenance review captures WHO authored each dependency.
          required_fields:
            - field: dependency_review_hash
              type: "map<stable_id, content_hash>"
              purpose: "Captures resolved hashes at review time"
            - field: dependency_review_timestamp
              type: "ISO-8601 timestamp"
              purpose: "Records when dependency hashes were captured"
            - field: dependency_provenance
              type: "map<stable_id, ProvenanceEntry>"
              purpose: "Captures author identity and admission receipt for each dependency"
            - field: ProvenanceEntry
              type: "object"
              schema:
                author_identity: "string - hash of producer's signing key"
                admission_receipt_hash: "string - CAS hash of admission receipt"
                reviewed_at: "ISO-8601 timestamp"
          compilation_behavior:
            on_hash_mismatch: "FAIL by default; WARN with --allow-hash-drift flag"
            on_unknown_author: "WARN if author_identity not on approved producer list"
            audit_event: "DependencyHashDrift emitted with old_hash, new_hash, stable_id"
      - kind_id: context_pack.manifest
        schema_id: cac.context_pack_manifest.v1
        normative: false
        consume_allowed: true
        purpose: Compiled output listing resolved stable IDs and hashes.
      - kind_id: receipt.admission
        schema_id: cac.admission_receipt.v1
        normative: false
        consume_allowed: true
        purpose: Evidence receipt proving artifact admission.
      - kind_id: receipt.aat
        schema_id: cac.aat_receipt.v1
        normative: false
        consume_allowed: true
        purpose: Evidence receipt proving acceptance/selftests passed.
      - kind_id: receipt.run
        schema_id: cac.run_receipt.v1
        normative: false
        consume_allowed: true
        purpose: Evidence receipt for consumption runs.
      - kind_id: escalation.policy
        schema_id: cac.escalation_policy.v1
        normative: true
        consume_allowed: true
        purpose: |
          Defines escalation governance for pack misses: authority_role (who can authorize),
          escalation_criteria (what conditions allow escalation), escalation_ttl (max duration
          before re-evaluation), audit_event_type (how escalations are recorded), and
          escalation_count_metric (feedback signal for pack specification improvement).
  pipeline:
    overview: |
      A closed-loop, message-native context pipeline: machines propose patches with semantic
      deltas; kernel admits canonical artifacts; compiler builds deep-pinned packs and
      target-specific payloads; consumption is hermetic and budgeted; misses create defects;
      improvements feed back into pack compilation and target profiles.
    stages:
      - stage_id: CAC-STAGE-01
        name: Patch Authoring
        mode: PRODUCE
        description: Machine authors propose changes as PatchRecords with ChangeSet reports.
      - stage_id: CAC-STAGE-02
        name: Admission Gate - Validate
        mode: KERNEL
        description: Fail-closed validation of patch against schema and policy.
      - stage_id: CAC-STAGE-03
        name: Admission Gate - Apply and Canonicalize
        mode: KERNEL
        description: Apply patch with replay protection, canonicalize, emit AdmissionReceipt.
      - stage_id: CAC-STAGE-04
        name: Publish to CAS and Update DCP
        mode: KERNEL
        description: Store canonical artifact in CAS, update DCP index via ledger events.
      - stage_id: CAC-STAGE-05
        name: Compile ContextPacks
        mode: PRODUCE
        description: Deep-pin transitive dependencies, produce manifests and derived packs.
      - stage_id: CAC-STAGE-06
        name: Target Delivery Rendering
        mode: PRODUCE
        description: Deterministic rendering to vendor layouts with provenance.
      - stage_id: CAC-STAGE-07
        name: Capability Truthing and Selftest (AAT)
        mode: PRODUCE
        description: Generate CapabilityManifest and AATReceipt from binary selftests.
      - stage_id: CAC-STAGE-08
        name: Consume (Execution/Review/Ops)
        mode: CONSUME
        description: Hermetic consumption with RunReceipt emission and defect tracking.
      - stage_id: CAC-STAGE-09
        name: Feedback Loop - Defect-to-Improvement
        mode: PRODUCE
        description: |
          DefectRecords aggregate into improvement signals. Pack specifications are
          reviewed when thresholds trigger. Feedback latency SLA is enforced.
    feedback_loop:
      description: |
        Closed-loop mechanism that converts DefectRecords from consumption into
        pack specification improvements. This operationalizes the conceptual
        feedback mentioned in the pipeline overview.
      aggregation:
        trigger_conditions:
          - id: TRIGGER-SIGNATURE-THRESHOLD
            condition: "Same defect signature occurs ≥3 times within 7 days"
            action: "Emit PACK_SPEC_REVIEW_NEEDED event"
          - id: TRIGGER-ESCALATION-FREQUENCY
            condition: "Same stable_id escalated ≥2 times within 14 days"
            action: "Prioritize stable_id in pack spec review queue"
          - id: TRIGGER-MISS-RATE-SPIKE
            condition: "context_pack_miss rate increases >50% week-over-week"
            action: "Alert DOMAIN_COMPILER team; emergency pack review"
        aggregation_window: "Rolling 7-day window with daily snapshots"
        clustering_algorithm: "Jaccard similarity on stable_id patterns"
      pack_review:
        cadence: "Weekly review of triggered pack specs; daily for emergency triggers"
        review_queue_priority:
          - "Emergency triggers (miss rate spike)"
          - "High-frequency escalation stable_ids"
          - "Recurring signature patterns"
        sla:
          during_rollout:
            standard_review: "24 hours from trigger to pack spec update"
            emergency_review: "4 hours from trigger to pack spec update"
          post_rollout:
            standard_review: "48 hours from trigger to pack spec update"
            emergency_review: "4 hours from trigger to pack spec update"
          transition: "Post-rollout SLA applies after week 8 of graduated enforcement"
      metrics:
        pack_spec_evolution_rate: "Count of pack spec updates per week"
        trigger_to_resolution_time: "Time from PACK_SPEC_REVIEW_NEEDED to merged update"
        feedback_effectiveness: "Reduction in defect recurrence after pack update"
  interfaces:
    external_apis:
      - name: ArtifactFetch Tool Protocol
        description: |
          Deterministic retrieval of context artifacts by stable ID or content hash.
          Policy enforces only stable-ID allowlisted reads in consumption mode.
        request_fields:
          - "stable_id (optional)"
          - "content_hash (optional)"
          - "expected_hash (optional)"
          - "max_bytes (required)"
          - "format (required): raw_bytes | utf8_text | json_canonical"
      - name: DcpResolve Tool Protocol
        description: |
          Resolve stable_id to pinned content hash and schema ref without fetching
          full content. Consumption-mode reads are still enforced.
    user_surfaces:
      - "apm2 cac lint - Validate CAC-JSON against schema."
      - "apm2 cac fmt - Canonicalize CAC-JSON to stable bytes."
      - "apm2 cac apply-patch - Submit patch with replay protection."
      - "apm2 pack compile - Compile ContextPacks from specs."
      - "apm2 export --profile <target> - Export to vendor layouts."
      - "apm2 capabilities --json - Generate capability manifest."
      - "apm2 selftest - Run AAT suite and emit receipt."
